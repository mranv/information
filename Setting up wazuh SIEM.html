<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Setting up wazuh SIEM</title>
  <style>
html {
color: #1a1a1a;
background-color: #fdfdfd;
}
body {
margin: 0 auto;
max-width: 36em;
padding-left: 50px;
padding-right: 50px;
padding-top: 50px;
padding-bottom: 50px;
hyphens: auto;
overflow-wrap: break-word;
text-rendering: optimizeLegibility;
font-kerning: normal;
}
@media (max-width: 600px) {
body {
font-size: 0.9em;
padding: 12px;
}
h1 {
font-size: 1.8em;
}
}
@media print {
html {
background-color: white;
}
body {
background-color: transparent;
color: black;
font-size: 12pt;
}
p, h2, h3 {
orphans: 3;
widows: 3;
}
h2, h3, h4 {
page-break-after: avoid;
}
}
p {
margin: 1em 0;
}
a {
color: #1a1a1a;
}
a:visited {
color: #1a1a1a;
}
img {
max-width: 100%;
}
svg {
height: auto;
max-width: 100%;
}
h1, h2, h3, h4, h5, h6 {
margin-top: 1.4em;
}
h5, h6 {
font-size: 1em;
font-style: italic;
}
h6 {
font-weight: normal;
}
ol, ul {
padding-left: 1.7em;
margin-top: 1em;
}
li > ol, li > ul {
margin-top: 0;
}
blockquote {
margin: 1em 0 1em 1.7em;
padding-left: 1em;
border-left: 2px solid #e6e6e6;
color: #606060;
}
code {
font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
font-size: 85%;
margin: 0;
hyphens: manual;
}
pre {
margin: 1em 0;
overflow: auto;
}
pre code {
padding: 0;
overflow: visible;
overflow-wrap: normal;
}
.sourceCode {
background-color: transparent;
overflow: visible;
}
hr {
background-color: #1a1a1a;
border: none;
height: 1px;
margin: 1em 0;
}
table {
margin: 1em 0;
border-collapse: collapse;
width: 100%;
overflow-x: auto;
display: block;
font-variant-numeric: lining-nums tabular-nums;
}
table caption {
margin-bottom: 0.75em;
}
tbody {
margin-top: 0.5em;
border-top: 1px solid #1a1a1a;
border-bottom: 1px solid #1a1a1a;
}
th {
border-top: 1px solid #1a1a1a;
padding: 0.25em 0.5em 0.25em 0.5em;
}
td {
padding: 0.125em 0.5em 0.25em 0.5em;
}
header {
margin-bottom: 4em;
text-align: center;
}
#TOC li {
list-style: none;
}
#TOC ul {
padding-left: 1.3em;
}
#TOC > ul {
padding-left: 0;
}
#TOC a:not(:hover) {
text-decoration: none;
}
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}

ul.task-list[class]{list-style: none;}
ul.task-list li input[type="checkbox"] {
font-size: inherit;
width: 0.8em;
margin: 0 0.8em 0.2em -1.6em;
vertical-align: middle;
}

pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
</head>
<body>
<p>SIEM(system information and event management) is set of tools and services that provide overview of organisations overall security through real-time event and log monitoring from multiple sources within the connected infrastructure.</p>
<p>Wazuh is a open source and free security platform that integrate SIEM and XDR (Extended Detection response) platform for endpoints and cloud workloads.</p>
<section id="wazuh-in-aws-ec2" class="level4">
<h4>Wazuh in AWS EC2</h4>
<p>EC2 is a cloud platform which provides secure and powerful cloud servers started by Amazon Web Services which is a subsidiary of Amazon that provides on-demand cloud computing platform.</p>
<section id="installation" class="level5">
<h5>Installation :</h5>
<ol type="1">
<li><p>Open ec2 dashboard select a name for the instance and operating system (for i case i chose ubuntu installing wazuh server)</p></li>
<li><p>Next choose a instance types this ranges from low computing, memory and networking needs to high. the requirements for wazuh server mainly depends on the number of the endpoint agents that has to be monitored and minimum requirement for single agent would be 2CPUs and 4gb ram. here t3.medium would suffice the needs.</p></li>
</ol>
<p>![[Screenshot from 2024-06-25 </p>
<ol start="3" type="1">
<li>Next create a key pair for security in case of linux it is .pem file and create a security group (Instance firewall). we can skip this for now.</li>
</ol>
<p>![[Pasted image </p>
<ol start="4" type="1">
<li><p>Select required gp2(ssd storage) selecting the right storage involves no. of the endpoint servers and the traffic attracted as all the intrusion logs, event logs needs to be sent to wazuh manager server. (50GB must be more than enough for testing)</p></li>
<li><p>Launch the instance.</p></li>
<li><p>Wait for 3-4 minutes for instance to start running and do a status check after that connect to the instance using ssh through terminal using <code>ssh -i keypair.pem ubuntu@&lt;ip.address&gt;</code> or instance connect.</p></li>
<li><p>Once you are logged in to the instance you can install the wazuh using step by step installation using this documentation https://documentation.wazuh.com/current/installation-guide/wazuh-server/step-by-step.html or quick assisted installation.</p>
<p><code>curl -sO https://packages.wazuh.com/4.7/wazuh-install.sh &amp;&amp; sudo bash ./wazuh-install.sh -a</code></p>
<p>The packages installed are : - gawk - a wazuh dependency (Tool that searches each line of input and perform specific task when the pattern is found.) - Wazuh indexer - It is a analytical and searching tool that pulls queried data from log files and stores it as json file - Filebeat - ships the log data from the agent server to indexer - Wazuh dashboard - Provides a interactable web UI for analysing and visualising the security events and alerts</p></li>
<li><p>Once the installation is finished username and password will be displayed To access the wazuh web portal update the security groups to open the 443 port where the wazuh web portal is running.</p></li>
<li><p>Now open the web portal through the browser using ec2 instance ip address and port 443 and input the user credential given while the installation.</p></li>
</ol>
<p>![[Screenshot from 2024-06-25 ![[Screenshot from 2024-06-24 10. Add agent</p>
<p>![[Screenshot from 2024-06-24 </p>
<ol start="11" type="1">
<li><p>Name the agent server, select the os of the agent server and fill the server ip for connecting with the server. ![[Screenshot from 2024-06-24 ![[Screenshot from 2024-06-24 </p></li>
<li><p>Copy the installation link and execute it in the agent server</p></li>
<li><p>now update the security group by allowing the agent server public ip to access your server to send the logs.</p></li>
</ol>
<p>![[Pasted image </p>
<ol start="14" type="1">
<li>Now start the wazuh agent</li>
</ol>
<p><code>systemctl daemon-reload</code> <code>systemctl enable wazuh-agent</code> <code>systemctl start wazuh-agent</code></p>
<p>In windows : open powershell and execute this: <code>NET START wazuh</code></p>
<section id="integrating-network-based-intrusion-detection-with-suricata" class="level6">
<h6>Integrating Network based intrusion detection with suricata</h6>
<ol type="1">
<li><strong>Install suricata</strong></li>
</ol>
<p><code>sudo add-apt-repository ppa:oisf/suricata-stable</code> <code>sudo apt-get update</code> <code>sudo apt-get install suricata -y</code></p>
<ol start="2" type="1">
<li><strong>Apply rulesets</strong></li>
</ol>
<p><code>cd /tmp/ &amp;&amp; curl -LO https://rules.emergingthreats.net/open/suricata-6.0.8/emerging.rules.tar.gz</code></p>
<p><code>sudo tar -xvzf emerging.rules.tar.gz &amp;&amp; sudo mv rules/*.rules /etc/suricata/rules/</code></p>
<p><code>sudo chmod 640 /etc/suricata/rules/*.rules</code></p>
<ol start="3" type="1">
<li><p>Navigate to /etc/suricata/suricata.yml to configure and enter the network interface in yml</p></li>
<li><p><strong>Start suricata</strong></p></li>
</ol>
<p><code>systemctl start suricata</code></p>
<ol start="5" type="1">
<li><p>Edit ossec.conf in wazuh agent machine to collect suricata logs from /var/log/suricata/eve.json</p></li>
<li><p><strong>Navigate to /var/ossec/etc/ossec.conf add this :</strong></p></li>
</ol>
<pre><code>&lt;ossec_config&gt;
  &lt;localfile&gt;
    &lt;log_format&gt;json&lt;/log_format&gt;
    &lt;location&gt;/var/log/suricata/eve.json&lt;/location&gt;
  &lt;/localfile&gt;
&lt;/ossec_config&gt;</code></pre>
<ol start="7" type="1">
<li>To filter network level events using suricata use rule.groups:suricata ruleset in field to filter out suricata alerts.</li>
</ol>
</section>
</section>
<section id="dashboards-and-visualisation" class="level5">
<h5>Dashboards and Visualisation</h5>
<section id="security-event-dashboard---ubuntu" class="level7">
<p class="heading">Security event dashboard - ubuntu</p>
<p>![[Screenshot from 2024-06-24 </p>
</section>
<section id="windows-event-dashboard" class="level7">
<p class="heading">Windows event dashboard</p>
<p>![[Screenshot from 2024-06-25 </p>
</section>
<section id="filtering-logs" class="level7">
<p class="heading">Filtering logs</p>
<p><strong>We can filter out custom events using available fields</strong></p>
<p>![[Screenshot from 2024-06-25 </p>
</section>
<section id="hipaa-compliance-requirements" class="level7">
<p class="heading">HIPAA Compliance Requirements</p>
<p>![[Screenshot from 2024-06-25 </p>
<p>![[Screenshot from 2024-06-25 </p>
</section>
<section id="security-configuration-assessment---recommendation" class="level7">
<p class="heading">Security Configuration Assessment - Recommendation</p>
<p>![[Screenshot from 2024-06-25 </p>
</section>
<section id="security-event-discription" class="level7">
<p class="heading">Security event discription</p>
<p>![[Screenshot from 2024-06-24 ![[Screenshot from 2024-06-24 </p>
</section>
<section id="mitre-dashboards" class="level7">
<p class="heading">MITRE dashboards</p>
<p>![[Pasted image </p>
<p>![[Screenshot from 2024-06-25 </p>
</section>
</section>
<section id="creating-custom-dashboards" class="level5">
<h5>Creating custom dashboards</h5>
<section id="geo-location-pinning-of-attacks" class="level6">
<h6>Geo-location pinning of attacks</h6>
<ol type="1">
<li>Click on create visualisation and select maps as a layer one</li>
</ol>
<p>![[Screenshot from 2024-06-24 </p>
<ol start="2" type="1">
<li>Now right side hamburger menu and select data source as wazuh-alerts-* and field as geo-location</li>
</ol>
<pre class="image-layout-a"><code>![[Screenshot from 2024-06-24 20-54-35.png]]
![[Screenshot from 2024-06-24 20-54-52.png]]</code></pre>
<ol start="3" type="1">
<li><p>we can also select styles and other customisations and then update as layer 2</p>
<p>this is the geo-location pinning of all login attemps :</p></li>
</ol>
<p>![[Screenshot from 2024-06-24 </p>
<p>Same way we can create more dashboards using data source and fields to filter certain logs.</p>
</section>
</section>
<section id="creating-alerting-system" class="level5">
<h5>Creating alerting system</h5>
<ol type="1">
<li><p>Opensearch offers alerting system that alerts if the given conditions are triggered</p></li>
<li><p>We need to create a monitor give a data source</p></li>
</ol>
<p>![[Screenshot from 2024-06-25 </p>
<ol start="3" type="1">
<li>We can also select type of monitor, frequency of monitoring etc</li>
</ol>
<p>![[Pasted image </p>
<ol start="4" type="1">
<li>We can also add scripts to run elaborate conditions and alerts eg.</li>
</ol>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>int score <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (int i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ctx<span class="op">.</span><span class="at">results</span>[<span class="dv">0</span>]<span class="op">.</span><span class="at">hits</span><span class="op">.</span><span class="at">hits</span><span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Weighs 500 errors 10 times as heavily as 503 errors</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (ctx<span class="op">.</span><span class="at">results</span>[<span class="dv">0</span>]<span class="op">.</span><span class="at">hits</span><span class="op">.</span><span class="at">hits</span>[i]<span class="op">.</span><span class="at">_source</span><span class="op">.</span><span class="at">http_status_code</span> <span class="op">==</span> <span class="st">&quot;500&quot;</span>) {</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    score <span class="op">+=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (ctx<span class="op">.</span><span class="at">results</span>[<span class="dv">0</span>]<span class="op">.</span><span class="at">hits</span><span class="op">.</span><span class="at">hits</span>[i]<span class="op">.</span><span class="at">_source</span><span class="op">.</span><span class="at">http_status_code</span> <span class="op">==</span> <span class="st">&quot;503&quot;</span>) {</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    score <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (score <span class="op">&gt;</span> <span class="dv">99</span>) {</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This script assigns score to http status codes, here 500 error is given score 10 and 503 code is given score 1. so the score keeps on adding as new connection attempts are made until it hits 100 and the trigger will set off.</p>
</section>
<section id="email-alerts" class="level5">
<h5>Email alerts</h5>
<ol type="1">
<li>To enable email alerts we need to navigate to /etc/ossec/etc/ossec.conf and add this configuration to the .conf file :</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="sourceCode conf"><code class="sourceCode toml"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;</span><span class="dt">ossec_config</span><span class="er">&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="er">&lt;</span><span class="dt">global</span><span class="er">&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        <span class="er">&lt;</span><span class="dt">email_notification</span><span class="er">&gt;</span><span class="dt">yes</span><span class="er">&lt;/</span><span class="dt">email_notification</span><span class="er">&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        <span class="er">&lt;</span><span class="dt">email_to</span><span class="er">&gt;</span><span class="dt">me</span><span class="er">@</span><span class="dt">test.com</span><span class="er">&lt;/</span><span class="dt">email_to</span><span class="er">&gt;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="er">&lt;</span><span class="dt">smtp_server</span><span class="er">&gt;</span><span class="dt">mail.test.com</span><span class="er">&lt;/</span><span class="dt">smtp_server</span><span class="er">&gt;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="er">&lt;</span><span class="dt">email_from</span><span class="er">&gt;</span><span class="dt">wazuh</span><span class="er">@</span><span class="dt">test.com</span><span class="er">&lt;/</span><span class="dt">email_from</span><span class="er">&gt;</span></span></code></pre></div>
<p>![[Screenshot from 2024-06-25 ![[Screenshot from 2024-06-25 </p>
<ol start="2" type="1">
<li>Now we will receive any security event alerts through. we can also change no. of alerts per hour.</li>
</ol>
</section>
<section id="creating-new-ruleset" class="level5">
<h5>Creating new ruleset</h5>
<ol type="1">
<li>Navigate to management and rules under that</li>
</ol>
<p>![[Screenshot from 2024-06-25 </p>
<ol start="2" type="1">
<li>Write a simple xml code to define the rule and name the ruleset</li>
</ol>
<p>![[Screenshot from 2024-06-25 </p>
<ol start="3" type="1">
<li>Test the ruleset</li>
</ol>
<p>![[Screenshot from 2024-06-25 </p>
</section>
</section>
</body>
</html>
